---
- name: Upgrade IM repo
  ansible.builtin.debug:
   msg: "IM repo->{{ im_upgrade_repo }}"

- name: Test connection to repo
  get_url:
    url: "{{ im_upgrade_repo }}"
    dest: /tmp/test_im_upgrade_repo.html
    mode: '0755'
    validate_certs: false
    timeout: 2
  register: repoexists
  ignore_errors: true

- name: Delete temp file
  file:
    state: absent
    path: /tmp/test_im_upgrade_repo.html

- name: Repo is not reachable
  ansible.builtin.debug:
   msg: "IM repo->{{ im_upgrade_repo }} is not reachable, skipping im upgrade"
  when: repoexists.msg search('Request failed')

- name: Repo is alive
  when: repoexists.msg search('OK')
  block:
    - name: Upgrade IM to the latest level
      ansible.builtin.shell: "{{ install_base_win}}{{ install_base }}/IM/eclipse/tools/imcl install com.ibm.cic.agent  -repositories {{ im_upgrade_repo }}"
      register: updateOutput

    - name: Upgrade output
      ansible.builtin.debug:
        msg: "{{ updateOutput.stdout_lines }}"
      failed_when: ( updateOutput.rc not in [ 0, 1 ] )
