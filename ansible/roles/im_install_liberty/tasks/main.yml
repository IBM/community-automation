---
### "ansible_architecture": "s390x",
### "ansible_architecture": "ppc64le",
### "ansible_architecture": "x86_64",
### "ansible_architecture": "chrp", --- AIX

- name: Install
  tags: install 
  block:
  - name: check if imcl installed as a prereq
    stat:
      path: "{{ install_base }}/IBM/InstallationManager/eclipse/tools/imcl"
    register: isimcl
    failed_when: isimcl.stat.exists == False

  - name: copy im_liberty.xml.xml template
    template:
     src: im_liberty.xml.j2
     dest: "im_liberty.xml"

  - name:  stop any running servers
    ignore_errors: true
    shell: "{{install_base }}/{{ liberty_dir }}/bin/server stop wlp1"

  - name:  uninstallAll
    shell: "{{ install_base }}/IBM/InstallationManager/eclipse/tools/imcl uninstallAll"
    register: uninstallAllOutput
    
  - name: uninstallAllOutput
    debug: 
     msg: "{{ uninstallAllOutput.stdout_lines }}"

  - name:  clear liberty dir
    shell: "rm -rf {{ install_base }}/{{ liberty_dir }}"
    #  - name:  clear plugins dir
    #    shell: "rm -rf {{ install_base }}/.ibm/"

  - name:  generate secureStorageFile.store
    shell: "{{install_base }}/IBM/InstallationManager/eclipse/tools/imutilsc saveCredential -url https://rtpgsa.ibm.com -userName {{ gsa_user }} -userPassword {{ gsa_pass }} -secureStorageFile {{ install_base }}/IBM/secureStorageFile.store"

  - name:  install liberty
    shell: "{{install_base }}/IBM/InstallationManager/eclipse/tools/imcl input ./im_liberty.xml -acceptLicense -secureStorageFile {{ install_base }}/IBM/secureStorageFile.store"
    register: installOutput

  - name: installOutput
    debug: 
     msg: "{{ installOutput.stdout_lines }}"

  - name:  listInstalledPackages
    shell: "{{install_base }}/IBM/InstallationManager/eclipse/tools/imcl listInstalledPackages"
    register: packageOutput
  
  - name: packageOutput
    debug: 
     msg: "{{ packageOutput.stdout_lines }}"

- name: Versions
  tags: version 
  block:
  - name: Liberty version
    shell: "{{install_base }}/{{ liberty_dir }}/bin/server version" 
    register: libertyVersionOutput

  - name: libertyVersionOutput
    debug: 
     msg: "{{ libertyVersionOutput.stdout_lines }}"

