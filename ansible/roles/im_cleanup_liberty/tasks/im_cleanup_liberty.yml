---

- name: Check if previous liberty installed
  ansible.builtin.stat:
    path: "{{ install_base }}/{{ liberty_dir }}/bin/server"
  register: islib

- name: Uninstall Liberty
  when: islib.stat.exists == True
  block: 
  - name:  Stop any running servers
    ignore_errors: true
    ansible.builtin.shell: "{{ install_base }}/{{ liberty_dir }}/bin/server stop {{ item }}"
    register: stopOutput
    failed_when: ( stopOutput.rc not in [ 0, 2, 23, 127 ] )
    with_items:
      - "{{ wl_server }}"
      - "{{ cc_server }}"

  # blindly try fuser ( linux )
  - name: Blindly try fuser ( linux )
    when: ansible_system is not search('CYG')
    ignore_errors: true
    ansible.builtin.shell: "fuser -k {{ item }}"
    register: killOutput
    failed_when: ( killOutput.rc not in [ 0, 1, 2, 127 ] )
    changed_when: false
    with_items:
      - "{{ install_base }}/{{ liberty_dir }}"

  # Windoze uninstallAll seems to be hanging, try to flush the hosts brain
  - name: Unconditionally reboot the machine with all defaults
    when: ansible_system == 'Windows' or 'CYG' in ansible_system
    ansible.builtin.reboot:
    become: true

  - name: Blindly try kill ( windoze )
    when: ansible_system == 'Windows' or 'CYG' in ansible_system
    ignore_errors: true
    ansible.builtin.shell: "ps -W|grep java|awk '{print $1}'|xargs kill -f"
    register: killOutput
    failed_when: ( killOutput.rc not in [ 0, 123 ] )
    changed_when: false

  - name: Uninstall liberty and java
    ansible.builtin.shell: "{{ install_base }}/IM/eclipse/tools/imcl uninstall {{ im_liberty_package }} com.ibm.java.jdk.v{{ im_java_short_version }}"
    register: uninstallOutput
    failed_when: ( uninstallOutput.rc not in [ 0, 1 ] )
    when: im_force_liberty == false

  # add this when / if the user changes the jdk versions
  - name: UninstallAll when im_force_liberty true
    ignore_errors: true
    ansible.builtin.shell: "{{ install_base }}/IM/eclipse/tools/imcl uninstallAll"
    register: uninstallOutput
    failed_when: ( uninstallOutput.rc not in [ 0, 1 ] )
    when: im_force_liberty == true

  - name: Uninstall liberty and java output
    ansible.builtin.debug: 
      msg: "{{ uninstallOutput.stdout_lines }}"

- name: Remove previous liberty dir
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  with_items:
    - "{{ install_base }}/{{ liberty_dir }}"
    - "{{ wlp_usr_dir }}"