---

# blindly try fuser ( linux )
- name:  blindly try fuser ( linux )
  ignore_errors: true
  shell: "fuser -k {{ item }}"
  register: killOutput
  failed_when: ( killOutput.rc not in [ 0, 1, 2, 127 ] )
  with_items:
  - "{{ install_ihs_base }}/{{ http_dir }}"

- name: check if previous ihs installed
  stat:
   path: "{{install_ihs_base }}/{{ http_dir }}/bin/apachectl"
  register: isihs

- name: Uninstall IHS/WCT/Plugin
  when: isihs.stat.exists == True
  block: 
  - name:  stop httpd
    ignore_errors: true
    shell: "{{install_ihs_base }}/{{ http_dir }}/bin/apachectl stop"

  - name:  stop adminctl
    ignore_errors: true
    shell: "{{install_ihs_base }}/{{ http_dir }}/bin/adminctl stop"

  - name:  uninstall wct
    shell: "{{ install_ihs_base }}/IM/eclipse/tools/imcl uninstall {{ im_wct_package[twas_release] }} {{ im_wct_java_package }} -installationDirectory {{ install_ihs_base }}/{{ wct_dir }}"
    register: uninstallWCTOutput
    failed_when: ( uninstallWCTOutput.rc not in [ 0, 1 ] )
    
  - name: uninstallWCTOutput
    debug: 
      msg: "{{ uninstallWCTOutput.stdout_lines }}"

  - name:  uninstall plugin
    shell: "{{ install_ihs_base }}/IM/eclipse/tools/imcl uninstall {{ im_plugin_package[twas_release] }} {{ im_plugin_java_package }} -installationDirectory {{ install_ihs_base }}/{{ plugin_dir }}"
    register: uninstallPLGOutput
    failed_when: ( uninstallPLGOutput.rc not in [ 0, 1 ] )
    
  - name: uninstallPLGOutput
    debug: 
      msg: "{{ uninstallPLGOutput.stdout_lines }}"

  - name:  uninstall http
    shell: "{{ install_ihs_base }}/IM/eclipse/tools/imcl uninstall {{ im_http_package[twas_release] }} {{ im_http_java_package }} -installationDirectory {{ install_ihs_base }}/{{ http_dir }}"
    register: uninstallIHSOutput
    failed_when: ( uninstallIHSOutput.rc not in [ 0, 1 ] )
    
  - name: uninstallIHSOutput
    debug: 
      msg: "{{ uninstallIHSOutput.stdout_lines }}"

  - name: Remove previous http/plugin/wct/ dir 
    file:
      path: "{{ item }}"
      state: absent
    with_items:
    - "{{ install_ihs_base }}/{{ http_dir }}"
    - "{{ install_ihs_base }}/{{ plugin_dir }}"
    - "{{ install_ihs_base }}/{{ wct_dir }}"
