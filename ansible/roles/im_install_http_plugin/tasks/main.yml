---
### "ansible_architecture": "s390x",
### "ansible_architecture": "ppc64le",
### "ansible_architecture": "x86_64",
### "ansible_architecture": "chrp", --- AIX

#uninstall all
#IBM/InstallationManager/eclipse/tools/imcl uninstallAll

#clear install dirs
#rm -rf 

#install
#IBM/InstallationManager/eclipse/tools/imcl input ./im_http_plugin.xml -acceptLicense -secureStorageFile /home/nest/IBM/secureStorageFile.store

- name: check if imcl installed as a prereq
  stat:
    path: "{{ install_base }}/IBM/InstallationManager/eclipse/tools/imcl"
  register: isimcl
  failed_when: isimcl.stat.exists == False

- name: copy ihs_plugin.xml template
  template:
   src: im_http_plugin.xml.j2
   dest: "im_http_plugin.xml"

- name: copy https_conf template
  template:
   src: https_conf.j2
   dest: "https_conf"

- name:  uninstallAll
  shell: "{{ install_base }}/IBM/InstallationManager/eclipse/tools/imcl uninstallAll"
  register: uninstallAllOutput
    
- name: uninstallAllOutput
  debug: 
   msg: "{{ uninstallAllOutput.stdout_lines }}"

- name:  clear http dir
  shell: "rm -rf {{ install_base }}/{{ http_dir }}"
- name:  clear plugins dir
  shell: "rm -rf {{ install_base }}/{{ plugin_dir }}"
- name:  clear wct dir
  shell: "rm -rf {{ install_base }}/{{ wct_dir }}"
- name:  clear the hidden .ibm/
  shell: "rm -rf {{ install_base }}/.ibm/"

- name:  generate secureStorageFile.store
  shell: "{{install_base }}/IBM/InstallationManager/eclipse/tools/imutilsc saveCredential -url https://rtpgsa.ibm.com -userName {{ gsa_user }} -userPassword {{ gsa_pass }} -secureStorageFile {{ install_base }}/secureStorageFile.store"

- name:  install http plugins wct
  shell: "{{install_base }}/IBM/InstallationManager/eclipse/tools/imcl input ./im_http_plugin.xml -acceptLicense -secureStorageFile {{ install_base }}/IBM/secureStorageFile.store"
  register: installOutput

#https://www.ibm.com/docs/en/was/9.0.5?topic=cwspi-configuring-web-server-plug-in-using-pct-toolhttps://www.ibm.com/docs/en/was/9.0.5?topic=cwspi-configuring-web-server-plug-in-using-pct-tool
- name: copy wct_definition.xml template
  template:
   src: wct_definition.xml.j2
   dest: "wct_definition.xml"
- name: copy wct_definition.xml template
  template:
   src: ihsserverkey.sh.j2
   dest: "{{ install_base }}/{{ http_dir }}/confg/ihsserverkey.sh"
   mode: 0755

- name:  configure plugin
  shell: "{{install_base }}/WCT/WCT/wctcmd.sh -tool pct -defLocPathname {{ install_base }}/{{ plugin_dir }} -defLocName ihsWebServer -createDefinition -response wct_definition.xml -importDefinitionLocation"
  register: configurepluginOutput

- name: Insert/Update https config
  blockinfile:
    path: "{{ install_base }}/{{ http_dir }}/conf/httpd.conf"
    block: |
      LoadModule ibm_ssl_module modules/mod_ibm_ssl.so
      Listen {{ https_port }}
      SSLCheckCertificateExpiration 30
      <VirtualHost *:{{ https_port }}>
       ServerName {{ ansible_hostname }}
       SSLEnable
       Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
      </VirtualHost>
      KeyFile {{ install_base }}/{{ http_dir }}/conf/ihsserverkey.kdb

- name:  configure plugin
  shell: "{{install_base }}/{{ http_dir }}/conf/ihsserverkey.sh"
  args:
    chdir: "{{ install_base }}/{{ http_dir }}/conf"
  register: createihsseververkdbOutput

- name: installOutput
  debug: 
   msg: "{{ installOutput.stdout_lines }}"

- name:  listInstalledPackages
  shell: "{{install_base }}/IBM/InstallationManager/eclipse/tools/imcl listInstalledPackages"
  register: packageOutput

- name: packageOutput
  debug: 
   msg: "{{ packageOutput.stdout_lines }}"

- name: configurepluginOutput
  debug: 
   msg: "{{ configurepluginOutput.stdout_lines }}"

- name: createihsseververkdbOutput
  debug: 
   msg: "{{ createihsseververkdbOutput.stdout_lines }}"
