---
- name: dynamicRouting_plugin
  tags: dynamicRouting 
  block:
  - name: check if ihs is installed
    stat:
      path: "{{ install_base }}/{{ http_dir }}/bin/gskcmd"
    register: ishttp
    failed_when: ishttp.stat.exists == False

  - name: copy generated files
    copy:
      src: "{{ item }}"
      dest: "{{ item }}"
    with_items:
    - plugin-cfg.xml
    - plugin-key.p12

    # some values defaults from
    # im_install_http_plugin/templates/wct_definition.xml.j2
    # im_install_http_plugin/defaults/main.yml
    # liberty_dynamicRouting/defaults/main.yml
  - name: gskcmd convert
    failed_when: false
    shell: "{{install_base }}/{{ http_dir }}/bin/gskcmd -keydb -convert -pw {{ admin_pwd }} -db plugin-key.p12 -old_format pkcs12 -target plugin-key.kdb -new_format cms -stash"
    args:
      chdir: "{{install_base }}/{{ plugin_dir }}/config/webserver1"
    register: gskcmdOutput

  - name: gskcmdOutput
    debug: 
     msg: "{{ gskcmdOutput.stdout_lines }}"

  - name: generate the dynamic routing files
    failed_when: false
    shell: "{{install_base }}/{{ http_dir }}/bin/gskcmd -cert -setdefault -pw {{ admin_pwd }} -db plugin-key.kdp -label default"
    args:
      chdir: "{{install_base }}/{{ plugin_dir }}/config/webserver1"
    register: gskcmdcertOutput

  - name: gskcmdcertOutput
    debug: 
     msg: "{{ gskcmdcertOutput.stdout_lines }}"
