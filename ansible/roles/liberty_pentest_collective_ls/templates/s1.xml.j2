<?xml version="1.0" encoding="UTF-8"?>
<server description="Penetration Testing server1">

    <!-- Enable features -->
   <featureManager>
      <feature>jakartaee-10.0</feature>		
      <feature>adminCenter-1.0</feature>
      <feature>batchManagement-1.0</feature>	    
      <feature>openidConnectClient-1.0</feature>
      <feature>socialLogin-1.0</feature> <!-- enables jwt-1.0 feature -->
      <feature>mpOpenAPI-3.1</feature>
      <feature>collectiveMember-1.0</feature>
      <feature>clusterMember-1.0</feature>
   </featureManager>

   <clusterMember name="pentCluster"/>

    <!--Note: features conflict with apiDiscovery: openapi-3.1, mpOpenAPI-1.1 -->
    <!--Note: keep apiDiscovery with batch features together to allow both adminCenter and openapi/ui to view batch -->

    <remoteFileAccess>
	    <writeDir>${server.config.dir}</writeDir>
	    <readDir>${server.config.dir}</readDir>
    </remoteFileAccess>


    <!-- added 9/29/2021 to use custom cipher list to resolve LUCKY13 vulnerabilities -->
    <ssl id="defaultSSLConfig"  securityLevel="CUSTOM" enabledCiphers="TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384 TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384 TLS_RSA_WITH_AES_256_GCM_SHA384 TLS_ECDH_ECDSA_WITH_AES_256_GCM_SHA384 TLS_ECDH_RSA_WITH_AES_256_GCM_SHA384" />

    <basicRegistry id="basic" realm="PentestRealm">
        <user name="adminUser" password="notAPwd4Admin"/>
        <user name="readerUser" password="notAPwd4Reader"/>
        <user name="employeeUser" password="notAPwd4Employee"/>
        <user name="managerUser" password="notAPwd4Manager"/>
        <user name="batchAdminUser" password="notAPwd4BatchAdmin"/>
        <user name="batchGroupAdminUser" password="notAPwd4BatchGroupAdmin"/>
        <user name="batchSubmitterUser" password="notAPwd4BatchSubmitter"/>
        <user name="batchMonitorUser" password="notAPwd4BatchMonitor"/>
        <user name="batchGroupMonitorUser" password="notAPwd4BatchGroupMonitor"/>
    </basicRegistry>

    <administrator-role>
        <user>adminUser</user>
    </administrator-role>

    <reader-role>
        <user>readerUser</user>
    </reader-role>

    <authorization-roles id="com.ibm.ws.batch">
      <security-role name="batchAdmin">
        <user name="batchAdminUser"/>
        <user name="adminUser"/>
      </security-role>
      <security-role name="batchGroupAdmin">
        <user name="batchGroupAdminUser"/>
      </security-role>
      <security-role name="batchSubmitter">
        <user name="batchSubmitterUser"/>
      </security-role>
      <security-role name="batchMonitor">
        <user name="batchMonitorUser"/>
      </security-role>
      <security-role name="batchGroupMonitor">
        <user name="batchGroupMonitorUser"/>
      </security-role>
    </authorization-roles>

   
   <!-- Added 08/30/2022 to handle Host Header Injection -->
    <httpEndpoint id="defaultHttpEndpoint"
	         host="*"
                 httpPort="9080"
	         httpsPort="9443" 
	         headersRef="xFrameHeaderID"/>
   <virtualHost id="default_host" >  
	   <hostAlias>${env.HOST_ALIAS}:9080</hostAlias> 
           <hostAlias>${env.HOST_ALIAS}:9443</hostAlias>
   </virtualHost>

   <!-- Added 09/12/2022 to handle X-Frame-Options Header -->
   <headers id="xFrameHeaderID">
	   <setIfMissing>X-Frame-Options:SAMEORIGIN</setIfMissing>
   </headers>

   <!-- Added 06/2024 to allow JWT API to work in collective -->
   <jwtBuilder id="defaultJWT"
	       signatureAlgorithm="RS256"
	       keyStoreRef="defaultKeyStore"
	       issuer="memberRoot"
	       keyAlias="default" />

      <openidConnectClient id="client01" clientId="client01" clientSecret="notAPwd4Client01" mapIdentityToRegistryUser="true" discoveryEndpointUrl="${OIDC_SERVER_DISCOVERY}/oidc/endpoint/OidcProvider/.well-known/openid-configuration" userInfoEndpointEnabled="true" authFilterRef="simpleServletFilter"/>

  <!-- needed by curl odic API -->   
    <authFilter id="simpleServletFilter">
        <requestUrl id="simpleServletUrl" matchType="contains" urlPattern="/SimpleServlet"/>
    </authFilter>


  <!-- 5/04/2021 added -->
  <oidcLogin id="client02" clientId="client02" clientSecret="notAPwd4Client02" displayName="client02" userInfoEndpointEnabled="true" mapToUserRegistry="true" authFilterRef="secureSimpleServletFilter" discoveryEndpoint="${OIDC_SERVER_DISCOVERY}/oidc/endpoint/OidcProvider/.well-known/openid-configuration" hostNameVerificationEnabled="false" signatureAlgorithm="HS256"/>

    <authFilter id="secureSimpleServletFilter">
        <requestUrl id="secureSimpleServletUrl" matchType="contains" urlPattern="/SecureSimpleServlet"/>
    </authFilter>

    <!-- 1/19/2022 added to disable welcome page and avoid / context root access -->
    <httpDispatcher enableWelcomePage="false"/>

    <!-- added addstricttransportsecurityheader to fix RTC 284528 --> 
    <webContainer disableXPoweredBy="true" addstricttransportsecurityheader="max-age=31536000;includeSubDomains"/>

    <!--Added 08/31/2022 to handle User Controllable URL Redirection -->
    <webAppSecurity ssoRequiresSSL="true" trackLoggedOutSSOCookies="true" sameSiteCookie="Strict" wasReqURLRedirectDomainNames="ibm.com"/>

    <!-- Automatically expand WAR files and EAR files --> 
    <applicationManager autoExpand="true"/>
    <application id="basicauth" location="basicauth.war" name="basicauth">
      <application-bnd>
         <security-role id="Employee" name="Employee">
            <user id="employeeUser" name="employeeUser"/>
         </security-role>
         <security-role id="Manager" name="Manager">
            <user id="managerUser" name="managerUser"/>
         </security-role>
      </application-bnd>
    </application>

    <httpSession cookieSecure="true" cookieName="PTSESSID" sslTrackingEnabled="true"/>

    <openapi enablePrivateURL="true"/>
   
      <!-- For Java Batch Persistence -->
    <!-- Derby JDBC driver -->
    <library id="DerbyLib"> 
	    <fileset dir="${server.config.dir}/resources/derby/derby_jars" includes="derby.jar,derbytools.jar,derbyshared.jar"/> 
    </library> 

    <!-- Data source for batch tables, and possibly other components. -->
    <dataSource id="DefaultDataSource"> 
        <jdbcDriver libraryRef="DerbyLib"/> 
	<properties.derby.embedded 
		databaseName="${server.config.dir}/resources/derby/RUNTIMEDB" 
		createDatabase="create" 
		user="dbuser1" password="notAPwd4dbuser1"/> 
    </dataSource>


    <logging maxFileSize="100" maxFiles="20" traceSpecification="*=info:com.ibm.ws.ui.*=all:com.ibm.ws.security.*=all:com.ibm.ws.webcontainer.security.*=all"/>

    <include location="${server.config.dir}/collectiveMember.xml" />

 </server>
