---

- name: remove Instana repository
  become: true
  ansible.builtin.yum_repository:
    name: instana-product
    state: absent

- name: Add Instana repository
  become: true
  ansible.builtin.yum_repository:
    name: instana-product
    description: instana-product
    baseurl: "https://_:{{ download_key }}@artifact-public.instana.io/artifactory/rel-rpm-public-virtual/"
    gpgkey: "https://_:{{ download_key }}@artifact-public.instana.io/artifactory/api/security/keypair/public/repositories/rel-rpm-public-virtual"
    gpgcheck: false
    repo_gpgcheck: true
    enabled: true

- name: Upgrade all packages
  become: true
  ansible.builtin.dnf:
    name: "*"
    state: latest

- name: install required OS packages
  become: true
  ansible.builtin.dnf:
    state: latest
    name: 
    - jq
    - postfix
    - stanctl
    - container-selinux 

- name: show the stanctl version
  command: 'stanctl --version'
  register: stanctlOutput

- name: stanctl stdout_lines
  debug: 
    msg: "{{ stanctlOutput.stdout }}"

- name: set transparent_hugepage
  become: true
  shell: 'grubby --args="transparent_hugepage=never" --update-kernel ALL'

- name: fix the postfix main.cf 01
  become: true
  lineinfile:
   path: /etc/postfix/main.cf
   state: present
   regexp: "#mynetworks_style = class"
   line: "mynetworks_style = class"
   backup: no

- name: fix the postfix main.cf 02
  become: true
  lineinfile:
   path: /etc/postfix/main.cf
   state: present
   regexp: "^smtpd_relay_restrictions"
   line: "smtpd_relay_restrictions = permit_mynetworks permit_sasl_authenticated defer_unauth_destination"
   backup: no

- name: fix the postfix main.cf 03
  become: true
  lineinfile:
   path: /etc/postfix/main.cf
   state: present
   regexp: "^smtpd_recipient_restrictions"
   line: "smtpd_recipient_restrictions = permit_mynetworks, permit_sasl_authenticated, reject_unauth_destination"
   backup: no
- name: fix the postfix main.cf 04
  become: true
  lineinfile:
   path: /etc/postfix/main.cf
   state: present
   regexp: "^smtpd_sender_restrictions"
   line: "smtpd_sender_restrictions = reject_unknown_sender_domain"
   backup: no

- name: Reload service postfix
  ansible.builtin.systemd_service:
    name: postfix.service
    state: reloaded
    enabled: true

- name: Unconditionally reboot the machine with all defaults
  ansible.builtin.reboot:


