---
- name: Any Cores?
  ansible.builtin.stat:
    path: "{{ wlp_usr_dir }}/servers/{{ wl_server }}/javacore*"
  register: iscore

- name: Any Heapdumps?
  ansible.builtin.stat:
    path: "{{ wlp_usr_dir }}/servers/{{ wl_server }}/heapdump*"
  register: isheap

- name: Dump archive logic
  when: iscore.stat.exists == True or isheap.stat.exists == True 
  block: 
  - name: Archive the liberty dump tar to fetch
    ignore_errors: True
    community.general.archive:
      path:
        - "{{ wlp_usr_dir }}/servers/{{ wl_server }}/javacore*"
        - "{{ wlp_usr_dir }}/servers/{{ wl_server }}/heapdump*"
      dest: dumps.tar
      format: tar
      exclusion_patterns:
        - '*.zip'
        - '*.tar'
        - '*.gz'

  - name: Fetch the liberty dump archive
    ansible.builtin.fetch:
      src: dumps.tar
      dest: "{{ dumpsDir }}/{{ env_name }}"

  - name: Remove temp dumps.tar
    ansible.builtin.file:
      path: dumps.tar
      state: absent

      # unarchive fails to find handler
  - name: Extract the liberty log archive
    delegate_to: localhost
    shell: tar xf dumps.tar
    args:
      chdir: "{{ dumpsDir }}/{{ env_name }}/{{ ansible_fqdn }}"

  - name: Remove dumps.tar
    delegate_to: localhost
    file:
      path: "{{ dumpsDir }}/{{ env_name }}/{{ ansible_fqdn }}/dumps.tar"
      state: absent

  - name: Dumps directory location
    debug:
      msg: "{{ dumpsDir }}/{{ env_name }}/{{ ansible_fqdn }}"
