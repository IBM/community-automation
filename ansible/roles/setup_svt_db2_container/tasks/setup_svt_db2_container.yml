---

- name: check for RedHat distribution
  fail:
    msg: Target OS is not RedHat
  when: ansible_distribution != "RedHat"

- name: Install RHEL pre-reqs
  become: yes
  dnf:
   name: "{{ packages }}"
   state: latest
  vars:
   packages:
   - podman

- name: Pull the svt db2 image
  containers.podman.podman_image:
    name: "{{ svt_db2_image }}"
    username: "{{ hyc_user }}"
    password: "{{ hyc_token }}"
    force: yes
    state: present
  register: svtop

- debug:
   msg: '{{ svtop }}'

- name: create dbdir directory
  file:
    path: "{{ item }}"
    state: directory
  with_items:
  - "/home/{{ ansible_user }}/dbdir"

# https://docs.ansible.com/ansible/latest/collections/containers/podman/podman_container_module.html#ansible-collections-containers-podman-podman-container-module
- name: Run svtdb container
  containers.podman.podman_container:
    log_level: info
    name: svtdb
    privileged: yes
    image: "{{ svt_db2_image }}"
    state: started
    restart: yes
    ports:
     - "50000:50000"
    volume:
     - "/home/{{ ansible_user }}/dbdir:/database"
    cmd_args:
     - "-e LICENSE=accept"
     - "-e DB2INST1_PASSWORD={{ db_pass }}"
     - "-e DBNAME={{ db_name }}"
     - "-e APP={{ svt_db_app }}"
  register: svtop

- debug:
   msg: '{{ svtop }}'

