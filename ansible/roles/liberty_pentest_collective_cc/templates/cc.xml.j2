<?xml version="1.0" encoding="UTF-8"?>
<server description="new server">

    <!-- Enable features -->
    <featureManager>
        <feature>jsp-2.3</feature>
	<feature>apiDiscovery-1.0</feature> 
	<!--<feature>restConnector-1.0</feature>-->
	<feature>localConnector-1.0</feature>
	<feature>batchManagement-1.0</feature>
	<feature>restConnector-2.0</feature>
	<feature>adminCenter-1.0</feature>
	<feature>javaee-8.0</feature>
	<feature>openidConnectServer-1.0</feature>
        <feature>openidConnectClient-1.0</feature>
	<feature>ssl-1.0</feature>
	<feature>scim-1.0</feature>
        <feature>dynamicRouting-1.0</feature>
        <feature>scalingController-1.0</feature>
        <feature>monitor-1.0</feature>
    </featureManager>

    <remoteFileAccess>
        <writeDir>${server.config.dir}</writeDir>
    </remoteFileAccess>

        <!-- added 9/29/2021 to use custom cipher list to resolve LUCKY13 vulnerabilities -->
    <ssl id="defaultSSLConfig" securityLevel="CUSTOM" enabledCiphers="TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384 TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384 TLS_RSA_WITH_AES_256_GCM_SHA384 TLS_ECDH_ECDSA_WITH_AES_256_GCM_SHA384 TLS_ECDH_RSA_WITH_AES_256_GCM_SHA384" />

    <basicRegistry id="basic" realm="PentestRealm">
        <user name="adminUser" password="notAPwd4Admin"/>
        <user name="readerUser" password="notAPwd4Reader"/>
        <user name="employeeUser" password="notAPwd4Employee"/>
        <user name="managerUser" password="notAPwd4Manager"/>
        <user name="batchAdminUser" password="notAPwd4BatchAdmin"/>
        <user name="batchGroupAdminUser" password="notAPwd4BatchGroupAdmin"/>
        <user name="batchSubmitterUser" password="notAPwd4BatchSubmitter"/>
        <user name="batchMonitorUser" password="notAPwd4BatchMonitor"/>
	<user name="batchGroupMonitorUser" password="notAPwd4BatchGroupMonitor"/>
	<group id="admins" name="admins">
          <member id="adminUser" name="adminUser"/>
        </group>
        <group id="readers" name="readers">
          <member id="readerUser" name="readerUser"/>
        </group>
        <group id="employees" name="employees">
          <member id="employeeUser" name="employeeUser"/>
        </group>
        <group id="managers" name="managers">
          <member id="managerUser" name="managerUser"/>
        </group>
    </basicRegistry>


    <administrator-role>
        <user>adminUser</user>
    </administrator-role>

    <reader-role>
        <user>readerUser</user>
    </reader-role>
    
    <authorization-roles id="com.ibm.ws.batch">
      <security-role name="batchAdmin">
        <user name="batchAdminUser"/>
        <user name="adminUser"/>
      </security-role>
      <security-role name="batchGroupAdmin">
        <user name="batchGroupAdminUser"/>
      </security-role>
      <security-role name="batchSubmitter">
        <user name="batchSubmitterUser"/>
      </security-role>
      <security-role name="batchMonitor">
        <user name="batchMonitorUser"/>
      </security-role>
      <security-role name="batchGroupMonitor">
        <user name="batchGroupMonitorUser"/>
      </security-role>
    </authorization-roles> 

    <!--    <collectiveController user="admin" password="password" /> -->
    
    <collectiveController user="adminUser" password="notAPwd4Admin" />

    <!-- Added 08/30/2022 to handle Host Header Injection -->
    <httpEndpoint id="defaultHttpEndpoint"
	         host="*"
                 httpPort="9080"
	         httpsPort="9443"
	         headersRef="xFrameHeaderID"/>
   <virtualHost id="default_host" >
	   <hostAlias>${env.HOST_ALIAS}:9080</hostAlias>
           <hostAlias>${env.HOST_ALIAS}:9443</hostAlias>
   </virtualHost>

   <!-- Added 09/12/2022 to handle X-Frame-Options Header -->
   <headers id="xFrameHeaderID">
	   <setIfMissing>X-Frame-Options:SAMEORIGIN</setIfMissing>
   </headers>

   <!-- 1/19/2022 added to disable welcome page and avoid / context root access -->
    <httpDispatcher enableWelcomePage="false"/>

    <!-- added addstricttransportsecurityheader to fix RTC 284528 --> 
    <webContainer disableXPoweredBy="true" addstricttransportsecurityheader="max-age=31536000;includeSubDomains"/>

    <!--Added 08/31/2022 to handle User Controllable URL Redirection -->
    <webAppSecurity ssoRequiresSSL="true" trackLoggedOutSSOCookies="true" sameSiteCookie="Strict" wasReqURLRedirectDomainNames="ibm.com"/>

   <httpSession cookieSecure="true" cookieName="PTSESSID" sslTrackingEnabled="true"/>
   
   <!-- Automatically expand WAR files and EAR files -->
    <applicationManager autoExpand="true"/>
    
    <!-- For Java Batch Persistence and OIDC OAuth service persistence  -->
    <!-- Derby JDBC driver -->
    <library id="DerbyLib">
	    <fileset dir="${server.config.dir}/resources/derby/derby_jars" includes="derby.jar,derbytools.jar,derbyshared.jar,derbyclient.jar,derbynet.jar"/>   
    </library>

    <!-- Data source for batch tables -->
    <dataSource id="DefaultDataSource">
        <jdbcDriver libraryRef="DerbyLib"/>
	   <properties.derby.embedded 
		   databaseName="${server.config.dir}/resources/derby/RUNTIMEDB" 
              createDatabase="create" 
	      user="dbuser1" password="notAPwd4dbuser1"/>
    </dataSource>

    <!-- Data source for batch tables for persistent OAuth service  -->
    <dataSource id="OAuthDataSource" >
        <jdbcDriver libraryRef="DerbyLib" />
           <properties.derby.embedded
		   databaseName="${server.config.dir}/resources/derby/OAuthTestDB"
               createDatabase="create"
               user="bob" password="notAPwd4dbuser1" />
   </dataSource>

   <openidConnectProvider id="OidcProvider" oauthProviderRef="OAuthProvider" keyStoreRef="defaultKeyStore" signatureAlgorithm="RS256" jwkEnabled="true"/>

   <!-- "internalClientId" is needed to get Personal Token and User Token management tools to display in admin center after it's registered manually via Client Management tool; internalClientID and internalClientSecret match a defined client and are used in creating app-passwords and app-tokens  -->

   <oauthProvider id="OAuthProvider" autoAuthorizeParam="autoauthz" tokenFormat="mpjwt" passwordGrantRequiresAppPassword="true" internalClientId="client_internal"  internalClientSecret="notAPwd4ClientInt" appPasswordLifetime="30d">           

	    <client id="client_internal" name="client_internal" secret="notAPwd4ClientInt" displayname="client_internal" scope="openid profile email ">
	    </client>

            <!-- The following 2 clients (previously were created via local store) are now created via database store and used for OIDC and Social Login REST API tests -->
            <client id="client01" name="client01" secret="notAPwd4Client01" displayname="client01" scope="openid profile email ">
                <redirect>${OIDC_CLIENT_REDIRECT}/oidcclient/redirect/client01</redirect>
            </client>
            <client id="client02" name="client02" secret="notAPwd4Client02" displayname="client02" scope="openid profile email ">
                <redirect>${OIDC_CLIENT_REDIRECT}/ibm/api/social-login/redirect/client02</redirect>
	    </client>

            <autoAuthorizeClient>client01</autoAuthorizeClient>
            <autoAuthorizeClient>client02</autoAuthorizeClient>
           <databaseStore dataSourceRef="OAuthDataSource" />                   
    </oauthProvider>
    <oauth-roles>
       <authenticated>
           <user name="adminUser"/>
           <special-subject type="ALL_AUTHENTICATED_USERS"/>
       </authenticated>
       <tokenManager>
           <!-- this user can manage the app-passwords and tokens of other users -->
            <user name="adminUser" />
       </tokenManager>
       <clientManager>
            <user name="adminUser" />
       </clientManager>
    </oauth-roles>

	       <!--<logging maxFileSize="100" maxFiles="20" traceSpecification="*=info:com.ibm.ws.ui.*=all:com.ibm.ws.security.*=all:com.ibm.ws.webcontainer.security.*=all"/> -->

	       <!--    <logging traceSpecification="com.ibm.ws.security.*=all:com.ibm.ws.webcontainer.*=all:com.ibm.ws.security.oauth*=finest:com.ibm.ws.security.openidconnect.*=all:com.ibm.ws.security.oauth20.*=all:com.ibm.ws.ui.*=all:com.ibm.ws.session.*=all" traceFileName="trace.log" maxFileSize="50" maxFiles="10" />
-->

<!--<logging maxFileSize="100" maxFiles="20" traceSpecification="*=info:com.ibm.ws.collective.rest.*=all:com.ibm.ws.collective.command.*=all:com.ibm.ws.collective.utils.*=all:com.ibm.ws.collective.repository.recorder.*=all:com.ibm.ws.collective.security.*=all:com.ibm.ws.collective.singleton.*=alli:com.ibm.ws.rest.handler.*=all:com.ibm.ws.rest.api.discovery.*=all"/>
-->

   <logging maxFileSize="100" maxFiles="20" traceSpecification="*=info:com.ibm.ws.collective.rest.*=all:com.ibm.ws.rest.handler.*=all:com.ibm.ws.jmx.*=all"/>


    <include location="${server.config.dir}/controller.xml" />
</server>

