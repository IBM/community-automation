---
- name: join collective
  tags: join_collective 
  block:
  - name: check if liberty is installed
    stat:
      path: "{{ install_base }}/{{ liberty_dir }}/bin/server"
    register: isliberty
    failed_when: isliberty.stat.exists == False

  - name:  stop existing server process
    ignore_errors: true
    shell: "{{ wlp_cmd }} {{ install_base }}/{{ liberty_dir }}/bin/server stop {{ wl_server }}"
    when: iscc.stat.exists == True
    register: op

  - debug:
     msg: '{{ op }}'

  - name:  join collective
    shell: "{{install_base }}/{{ liberty_dir }}/bin/collective join {{ wl_server }} --host={{ cc_hostname }} --port={{ liberty_admin_ports }} --hostname={{ ansible_fqdn }} --user={{ liberty_admin_user }} --password={{ liberty_admin_pass }} --keystorePassword={{ liberty_admin_pass }} --autoAcceptCertificates --createConfigFile=collectiveMember.xml"
    args:
      chdir: "{{ wlp_usr_dir }}/servers/{{ wl_server }}"
    register: joinOutput

  - debug:
     msg: "{{ joinOutput.stdout_lines }}"

  - name: update to tlsv1.2
    lineinfile:
      path: "{{ wlp_usr_dir }}/servers/{{ wl_server }}/collectiveMember.xml"
      regexp: '^sslProtocol="TLSv1.2"'
      insertafter: '<ssl id="defaultSSLConfig"'
      line: '     sslProtocol="TLSv1.2"'

  - name: autoAcceptCertificates
    lineinfile:
      path: "{{ wlp_usr_dir }}/servers/{{ wl_server }}/server.env"
      regexp: 'autoAcceptCertificates'
      line: 'JVM_ARGS=-Dcom.ibm.websphere.collective.utility.autoAcceptCertificates=true'

  - name: include collectiveMember.xml in server.xml
    lineinfile:
      path: "{{ wlp_usr_dir }}/servers/{{ wl_server }}/server.xml"
      regexp: '^controller.xml'
      insertbefore: '</server>'
      line: '    <include location="${server.config.dir}/collectiveMember.xml" />'

  - name: create logs dir before setting ( IBM i HACK )
    when: ansible_system == 'OS400'
    file:
      path: "{{ item }}"
      state: directory
    with_items:
    - "{{ wlp_usr_dir }}/servers/{{ cc_server }}/logs"
    - "{{ wlp_usr_dir }}/servers/.logs"
    - "{{ wlp_usr_dir }}/servers/.pid"

  - name: Conditional role
    include_role:
      name: liberty_ibmi_grantauth

      #  - block:
      #    - name:  OS400 perms qejbsvr
      #      shell: "chown -R {{ wlp_owner }} {{ wlp_usr_dir }} {{ wlp_output }}"
      #      register: chmodOutput
      #    - debug:
      #       msg: "{{ chmodOutput.stdout_lines }}"
      #    when: ansible_system == 'OS400'
